[gcode_macro flatten_slab]
gcode:
    {% set max_x = printer.configfile.config["stepper_x"].position_max %}
    {% set max_y = printer.configfile.config["stepper_y"].position_max %}
    {% set cut_depth = params.cut_depth|default(-1)|float %}

    {% set feed_rate = (params.feed_rate|default(10)|float)*60 %} #mm/s x60 for mm/min

    {% set step_over = params.step_over|default(20)|float %}
    {% set spindle_speed = params.spindle_speed|default(10000)|float %}
    
    M3 {spindle_speed}
    G90 ; Absolute positioning
    G21 ; Set units to millimeters
    G0 Z5 F{feed_rate/10} ; Move to safety height

    {% for ypos in range(0, y + step_over, step_over) %}
        G0 X0 Y{ypos} ; Move to starting position
        G1 Z{zcut_depth} F{feed_rate/10} ; Lower to cutting depth
        G1 X{x} F{feed_rate} ; Cut along the X axis
        G0 Z5 ; Raise to safety height
    {% endfor %}
